import{l as X,b as Y,f as H,d as K,r as o,j as e,a as R,g as Q,s as Z,h as ee,i as se}from"./index-BLZ4aqdM.js";import{u as re}from"./index.esm-DL-DIQfq.js";import{D as ae,k as c}from"./index-wjiC_Ptq.js";import{A as te}from"./AreaGovernmentSelector-CD9F4H2p.js";import{U as de}from"./UserSelector2-skhRGQwT.js";import{X as E}from"./x-wPlK3RzG.js";import"./data-DhDULqLU.js";const he=()=>{const{id:j}=X(),N=Y(),{updateADs:oe}=H(),{getUserEmail:ie}=K(),[g,F]=o.useState({images:0,video:0}),[k,w]=o.useState(!1),[l,h]=o.useState({images:[],video:""}),[D,S]=o.useState([]),[$,C]=o.useState([]),[b,P]=o.useState({area:"",govern:[]}),[L,U]=o.useState(null),[G,M]=o.useState(!0),{register:y,handleSubmit:T,reset:le,setValue:x,formState:{errors:f}}=re();o.useEffect(()=>{(async()=>{var r,d,t;try{const a=(await R.get(`/advertisement/get_one/${j}`)).data.advertisement;console.log("edit Ad page Data",a),x("title",a.title),x("description",a.description),x("startDate",a.startDate.split("T")[0]),x("endDate",a.endDate.split("T")[0]),h({images:a.Images||[],video:a.videos||""}),a.videos&&U(a.videos);const m=a.links.map(i=>i);S(m||[]),console.log("links",m);const v=a.users.map(i=>i.userId._id);C(v),console.log("users",v);const p=((r=a.address)==null?void 0:r.govern.map(i=>i))||[],A=((d=a.address)==null?void 0:d.area)||"";console.log("selectedGovernments",p),console.log("selectedArea",A),P({area:((t=a.address)==null?void 0:t.area)||"",governments:p}),M(!1)}catch(n){c.error(`Error fetching ad data: ${n.message}`)}})()},[j,x,N]);const q=o.useCallback(({selectedArea:s,selectedGovernments:r})=>{P(d=>d.area!==s||JSON.stringify(d.govern)!==JSON.stringify(r)?{area:s,govern:r}:d)},[]),B=(s,r)=>new Date(s)<=new Date(r),_=s=>{h(r=>({...r,images:r.images.filter((d,t)=>t!==s)}))},J=()=>{h(s=>({...s,video:""})),U(null)},I=async(s,r)=>{if(!s.length)return;w(!0);const d=r==="images"?["image/jpeg","image/png","image/gif","image/webp"]:["video/mp4","video/webm"],t=Array.from(s).find(a=>!d.includes(a.type));if(t){c.error(`نوع الملف غير مدعوم: ${t.name}`),w(!1);return}if(r==="video"&&s[0]){const a=URL.createObjectURL(s[0]);U(a)}const n=Array.from(s).map(a=>{const v=Q(Z,`noUser/${r}/${a.name}`),p=ee(v,a);return new Promise((A,i)=>{p.on("state_changed",u=>{const z=u.bytesTransferred/u.totalBytes*100;F(W=>({...W,[r]:z}))},i,async()=>{try{const u=await se(p.snapshot.ref);A(u)}catch(u){i(u)}})})});try{const a=await Promise.all(n);h(m=>({...m,[r]:r==="images"?[...m.images,...a]:a[0]}))}catch(a){c.error(`خطأ في رفع الملفات: ${a.message}`)}finally{w(!1)}},O=(s,r)=>{S(d=>{const t=[...d];return t[s]={...t[s],link:r},t})},V=async s=>{var d;if(!B(s.startDate,s.endDate)){c.error("تاريخ البداية يجب أن يكون قبل تاريخ النهاية");return}if(console.log("selectedAddress.govern",b),!b.govern.length){c.error("يجب اختيار المنطقة");return}const r={...s,address:b,Images:(d=l.images)!=null&&d.length?l.images:["https://firebasestorage.googleapis.com/v0/b/default-placeholder-image.jpg"],videos:l.video,links:D.filter(t=>{var n;return(n=t.link)==null?void 0:n.trim()}),users:$};try{const t=await R.put(`/advertisement/edit/${j}`,r);console.log("response.data",t.data),c.success("تم تحديث الإعلان بنجاح"),N("/dashboard/ads-list")}catch(t){c.error(`خطأ في تحديث الإعلان: ${t.message}`)}};return G?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"text-xl",children:"جاري التحميل..."})}):e.jsxs("div",{className:"p-4 md:p-8 bg-gray-50 dark:bg-gray-800 min-h-screen",children:[e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800 dark:text-white mb-6",children:"تعديل الإعلان"}),e.jsxs("form",{onSubmit:T(V),className:"bg-white dark:bg-gray-700 rounded-xl shadow-lg p-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"عنوان الإعلان"}),e.jsx("input",{...y("title",{required:"عنوان الإعلان مطلوب"}),className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600"}),f.title&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:f.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"وصف الإعلان"}),e.jsx("textarea",{...y("description",{required:"وصف الإعلان مطلوب"}),rows:4,className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600"}),f.description&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:f.description.message})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"تاريخ البداية"}),e.jsx("input",{type:"date",...y("startDate",{required:"تاريخ البداية مطلوب"}),className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"تاريخ النهاية"}),e.jsx("input",{type:"date",...y("endDate",{required:"تاريخ النهاية مطلوب"}),className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600"})]})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"صور الإعلان"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:s=>I(s.target.files,"images"),className:"hidden",id:"image-upload"}),e.jsx("label",{htmlFor:"image-upload",className:"cursor-pointer bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50",children:"اختر الصور"}),e.jsx("p",{className:"text-xs text-gray-500",children:"PNG, JPG, GIF حتى 10MB"})]})}),l.images.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:l.images.map((s,r)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:s,alt:`Preview ${r+1}`,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("button",{type:"button",onClick:()=>_(r),className:"absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(E,{size:16})})]},r))}),g.images>0&&g.images<100&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"h-2 bg-gray-200 rounded-full",children:e.jsx("div",{className:"h-2 bg-blue-500 rounded-full",style:{width:`${g.images}%`}})})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"فيديو الإعلان"}),e.jsx("div",{className:"mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg",children:e.jsxs("div",{className:"space-y-1 text-center",children:[e.jsx("input",{type:"file",accept:"video/*",onChange:s=>I(s.target.files,"video"),className:"hidden",id:"video-upload"}),e.jsx("label",{htmlFor:"video-upload",className:"cursor-pointer bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50",children:"اختر الفيديو"}),e.jsx("p",{className:"text-xs text-gray-500",children:"MP4, WebM حتى 100MB"})]})}),(L||l.video)&&e.jsxs("div",{className:"mt-4 relative group",children:[e.jsx("video",{controls:!0,className:"w-full max-h-64 rounded-lg",src:L||l.video,children:"Your browser does not support the video tag."}),e.jsx("button",{type:"button",onClick:J,className:"absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(E,{size:16})})]}),g.video>0&&g.video<100&&e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"h-2 bg-gray-200 rounded-full",children:e.jsx("div",{className:"h-2 bg-blue-500 rounded-full",style:{width:`${g.video}%`}})})})]})]})]}),e.jsxs("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx(te,{onSelectionChange:q,initialData:b})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-4",children:"روابط التواصل الاجتماعي"}),D.map((s,r)=>e.jsx("div",{className:"mb-2",children:e.jsx("input",{type:"url",value:s.link||"",onChange:d=>O(r,d.target.value),className:"w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600",placeholder:"أدخل رابط التواصل الاجتماعي"})},r)),e.jsx("button",{type:"button",onClick:()=>S([...D,{link:""}]),className:"mt-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"إضافة رابط جديد"})]})]}),e.jsx("div",{className:"mt-8",children:e.jsx(de,{initialSelectedUsers:$,onSelectionChange:C})}),e.jsxs("div",{className:"mt-8 flex gap-4",children:[e.jsx("button",{type:"submit",disabled:k,className:`flex-1 py-3 px-4 rounded-lg text-white font-medium ${k?"bg-gray-400 cursor-not-allowed":"bg-blue-500 hover:bg-blue-600"}`,children:k?"جاري التحديث...":"حفظ التغييرات"}),e.jsx("button",{type:"button",onClick:()=>N("/dashboard/ads"),className:"flex-1 py-3 px-4 rounded-lg text-gray-700 font-medium border border-gray-300 hover:bg-gray-50",children:"إلغاء"})]})]})]}),e.jsx(ae,{position:"top-center"})]})};export{he as default};
